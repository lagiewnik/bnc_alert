<!DOCTYPE html>
<html lang="en">

<head>
    <title>All Signals View</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/alert.css">
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <!-- <script src="/sorttable.js"></script> -->
    <script type="text/javascript" src="/tools.js"></script>
    <script type="text/javascript" src="DataTables/datatables.min.js"></script> 
</head>

<body>
    <script type="text/javascript">
        changeBackgroundColor();
    </script>
    <%- include('navbar.ejs') %>
    
    <div class="container">
        <br>
        <div class="container">

            <h1>Signals</h1>
            <p>Aktualne sygna≈Çy</p>
            
            <table id="dptable" class="table sortable">
                <thead class="allSignalsHeader">
                    <tr>
                        <th data-type="@data-sort">Observe</th>
                        <th>Symbol</th>
                        <th>Period</th>
                        <th>Od</th>
                        
                        <th>mmd Send Date</th>
                        <th>mmd Buy Score</th>
                        <th>mmd Sell Score</th>
                        <th>Fast Vs Short MMD</th>
                        <th>Fast Vs Middle MMD</th>
                        <th>Short Vs Middle MMD</th>
                        <th>Send Date</th>
                        <th>Buy Score</th>
                        <th>Sell Score</th>
                        <th>Cross Tenkan Kijun</th>
                        <th>cross VS Kumo</th>
                        <th>Cross Price Kijun</th>
                        <th>cross Price Chikou</th>
                        <th>kumo Color</th>
                        <th>price Vs Kumo</th>
                        <th>Signal 3Line</th>
                        <th>Chikou Span Vs Price</th>
                        

                    </tr>
                </thead>
                <tbody>
                    <% if (signals.length> 0) { %>
                        <% signals.forEach(sig=> { %>
                            <tr>
                                <td><input symbol="<%= sig.symbol %>" type="button" data-sort="<%= sig.button_function %>" sorttable_customkey="<%= sig.button_function %>"
                                        class=" btn btn-dark form-control <%= sig.button_function %>-symbol-observed"
                                        value="<%= sig.button_function %>"></td>
                                <td class="coin-data"><span class="dpsym">
                                        <%= sig.symbol %>
                                    </span>
                                    <span class="coin-price"></span>
                                </td>
                                <td><span class="dpaon">
                                        <%= sig.period %>
                                    </span></td>
                                <td><span class="dpcurtype">
                                        <%= sig.startTime %>
                                    </span></td>
                                
                                    <td><span class="dpcond">
                                        <%= sig.sendDateMMD %>
                                    </span></td>
                                <td><span class="dpprice1">
                                        <%= sig.mmdBuyScore %>

                                    </span></td>
                                <td><span class="dpprice2">
                                        <%= sig.mmdSellScore %>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.FastVsShortMMD %>
                                            
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.FastVsMiddleMMD %>
                                            
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.ShortVsMiddleMMD %>
                                           
                                    </span></td>
                                    <td><span class="dpcond">
                                        <%= sig.sendDate %>
                                    </span></td>
                                <td><span class="dpprice1">
                                        <%= sig.buyScore %>

                                    </span></td>
                                <td><span class="dpprice2">
                                        <%= sig.sellScore %>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.CrossTenkanKijun %>
                                            <img src="<%= sig.CrossTenkanKijun_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.crossVSKumo %>
                                            <img src="<%= sig.crossVSKumo_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.CrossPriceKijun %>
                                            <img src="<%= sig.CrossPriceKijun_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.crossPriceChikou %>
                                            <img src="<%= sig.crossPriceChikou_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.kumoColor %>
                                            <img src="<%= sig.kumoColor_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.priceVsKumo %>
                                            <img src="<%= sig.priceVsKumo_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.Signal3Line %>
                                            <img src="<%= sig.Signal3Line_img %>" alt>
                                    </span></td>
                                <td><span class="indicator">
                                        <%= sig.ChikouSpanVsPrice %>
                                            <img src="<%= sig.ChikouSpanVsPrice_img %>" alt>
                                    </span></td>
                            </tr>
                            <% }) %>
                                <% } %>
                </tbody>
            </table>
            <div class="form-group col-sm-2">
                <table>
                    <tr>
                        <td>
                            <select style='width:auto;' name="currency" id="currency" placeholder="Id"
                                class="chosen-select form-control"></select>
                        </td>
                        <td><input id="symboladd" type="button" class="btn btn-dark form-control"
                                value="Add to observed"></td>
                        <td></td>
                    </tr>
                </table>
            </div>
            <div class="form-group col-sm-2">
                <table><tbody>
                    <% if (observedsymbols.length> 0) { %>
                        <% observedsymbols.forEach(sig=> { %>
                            <tr>
                                <td><input symbol="<%= sig.symbol %>" type="button"
                                        class="btn btn-dark form-control delete-symbol-observed"
                                        value="delete"></td>
                                <td><span class="dpsym">
                                        <%= sig.symbol %>
                                    </span>
                                </td>
                            </tr>
                            <% }) %>
                                <% } %>
                </tbody></table>
            </div>


        </div>
        <footer>
        </footer>
</body>


</html>
<script>

    

        $(document).ready(function () {
            //getallsymbols()
            changeBackgroundColor()
            $('#dptable').DataTable({
                paging: false,
                aaSorting: [[0, 'desc']]
            })
            let timer = setTimeout(function delayrun() {
                getPrices();
                timer = setTimeout(delayrun, 10000);
            }, 10000);
        })

    function getallsymbols() {
        var ourRequest1 = new XMLHttpRequest();
        var url = 'https://api.binance.com/api/v3/ticker/price';
        ourRequest1.open('GET', url, true);
        ourRequest1.onload = function () {
            ourData = JSON.parse(ourRequest1.responseText);
            var regx = new RegExp("USDT" + "$");
            var regxUP = new RegExp("UPUSDT" + "$");
            var regxDOWN = new RegExp("DOWNUSDT" + "$");
            var regxETH = new RegExp("ETH$");
            var regxBNB = new RegExp("BNB$");
            var regxBTC = new RegExp("BTC$");
            ourData = ourData.filter(function (entry) {
                return (regx.test(entry.symbol) & !(regxUP.test(entry.symbol)) & !(regxDOWN.test(entry.symbol)))
            })
            ourData.sort(function (a, b) {
                if (a.symbol < b.symbol) {
                    return -1;
                }
                if (a.symbol > b.symbol) {
                    return 1;
                }
                return 0;
            }
            )
            console.log(ourData)
            //gv_symbols = gv_symbols.concat(ourData);
            var optionsAsString = '';
            //document.getElementById('currentprice').value = ourData[0]["price"];
            for (i = 0; i < ourData.length; i++) {
                optionsAsString += "<option value='" + ourData[i]["symbol"] + "'>" + ourData[i]["symbol"] + "</option>";
            }
            $('select[name="currency"]').append(optionsAsString);
        }
        ourRequest1.send();
    }
    
    $(".delete-symbol-observed").click(function (e) {

        var symbol = e.target.getAttribute("symbol");
        //$(this).parents("tr").remove();
        const deleteEndpoint = '/signalsobserved/' + symbol
        fetch(deleteEndpoint, {
            method: "DELETE"
        }).then((response) => response.json())
            .then((data) => {
                console.log(data)
                window.location.href = data.redirect
            })
            .catch((err) => {
                console.log(err)
            })


    });

    $(".add-symbol-observed").click(function (e) {
        var symbol = e.target.getAttribute("symbol");
        console.log("symbol data: " + symbol)

        dataToSend = JSON.stringify({ "symbol": symbol });
        console.log("datasend create alert:");
        console.log(dataToSend);
        fetch('/signals/' + symbol, {
            method: "POST",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: dataToSend
        }).then((response) => response.json())
            .then((data) => {
                console.log(data)
                window.location.href = data.redirect
            })
            .catch((err) => {
                console.log(err)
            })
    });

    $("#symboladd").click(function (e) {
        var symbol = $("#currency option:selected").text().trim();
        console.log("symbol data: " + symbol)

        dataToSend = JSON.stringify({ "symbol": symbol });
        console.log("datasend create alert:");
        console.log(dataToSend);
        fetch('/signals/' + symbol, {
            method: "POST",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: dataToSend
        }).then((response) => response.json())
            .then((data) => {
                console.log(data)
                window.location.href = data.redirect
            })
            .catch((err) => {
                console.log(err)
            })
    });

    
</script>